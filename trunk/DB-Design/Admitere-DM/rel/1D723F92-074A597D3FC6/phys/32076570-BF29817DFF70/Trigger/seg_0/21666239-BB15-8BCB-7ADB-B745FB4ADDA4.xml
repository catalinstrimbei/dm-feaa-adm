<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="TRG_CERERI_INS_AFTER_ROW" id="21666239-BB15-8BCB-7ADB-B745FB4ADDA4" directorySegmentName="seg_0">
   <createdBy>catalin.strimbei</createdBy>
   <createdTime>2011-04-20 12:49:06 UTC</createdTime>
   <changedBy>catalin.strimbei</changedBy>
   <changedTime>2011-04-20 12:49:06 UTC</changedTime>
   <ownerDesignName>Admitere-DM</ownerDesignName>
   <actions>INSERT</actions>
   <body>DECLARE&amp;lt;br/&amp;gt;    v_are_voie BOOLEAN := FALSE ;&amp;lt;br/&amp;gt;    v_stare VARCHAR2(300) := &amp;apos;&amp;apos; ;&amp;lt;br/&amp;gt;BEGIN  &amp;lt;br/&amp;gt;    FOR i IN 1..pac_variabile_globale.vg_roluri.COUNT LOOP&amp;lt;br/&amp;gt;        IF pac_variabile_globale.vg_roluri (i) IN (&amp;apos;DBA&amp;apos;, &amp;apos;PRODECAN&amp;apos;, &amp;apos;CERERI&amp;apos;) THEN&amp;lt;br/&amp;gt;            v_are_voie := TRUE ;&amp;lt;br/&amp;gt;        END IF ;            &amp;lt;br/&amp;gt;    END LOOP ; &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    IF v_are_voie = FALSE THEN&amp;lt;br/&amp;gt;        RAISE_APPLICATION_ERROR (-20146,&amp;apos;Nu aveti drepturi sa inserati in CERERI&amp;apos;) ; &amp;lt;br/&amp;gt;    END IF ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;   -- pac_variabile_globale.p_init_vg_atribute (&amp;apos;CERERI&amp;apos;) ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    v_stare := &amp;apos;Inserare in CERERE idfisa: &amp;apos;|| :NEW.idfisa ; &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    SELECT seq_idmodif.NextVal INTO pac_variabile_globale.v_seq_idmodif FROM dual ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    INSERT INTO admitere.modificari (idmodif, dataoram, operator, statiem, obs, idfisa, tip_modif, tabela)&amp;lt;br/&amp;gt;        VALUES (pac_variabile_globale.v_seq_idmodif, SYSDATE, &amp;lt;br/&amp;gt;            admitere.pac_variabile_globale.vg_operator, &amp;lt;br/&amp;gt;            admitere.pac_variabile_globale.vg_statie,&amp;lt;br/&amp;gt;            &amp;apos;ins-CERERI&amp;apos;, :NEW.idfisa, &amp;apos;I&amp;apos;, &amp;apos;CERERI&amp;apos;) ;    &amp;lt;br/&amp;gt;    &amp;lt;br/&amp;gt;    INSERT INTO ins_CERERI &amp;lt;br/&amp;gt;          (NUMAR, DATAOPERARII, DATASOLUTIONARII, FSTUDIISOLICIT, TAXASOLICIT, LOCSOLICIT,&amp;lt;br/&amp;gt;            OPERATORSOLUTIONARE, STATIESOLUTIONARE, STATIEOPERARE, VERDICT,&amp;lt;br/&amp;gt;            IDFISA, OBSERVATII, IDMODIF, specsolicit) &amp;lt;br/&amp;gt;        VALUES (&amp;lt;br/&amp;gt;            :NEW.NUMAR, :NEW.DATAOPERARII, :NEW.DATASOLUTIONARII, :NEW.FSTUDIISOLICIT, &amp;lt;br/&amp;gt;            :NEW.TAXASOLICIT, :NEW.LOCSOLICIT,&amp;lt;br/&amp;gt;            :NEW.OPERATORSOLUTIONARE, :NEW.STATIESOLUTIONARE, :NEW.STATIEOPERARE, :NEW.VERDICT,&amp;lt;br/&amp;gt;            :NEW.IDFISA, :NEW.OBSERVATII, &amp;lt;br/&amp;gt;            pac_variabile_globale.v_seq_idmodif, :NEW.specsolicit);&amp;lt;br/&amp;gt;  &amp;lt;br/&amp;gt;    IF :NEW.verdict in (&amp;apos;A&amp;apos;,&amp;apos;P2&amp;apos;, &amp;apos;P3&amp;apos;, &amp;apos;P4&amp;apos;) THEN&amp;lt;br/&amp;gt;      IF :new.taxasolicit is null OR :new.locsolicit is null &amp;lt;br/&amp;gt;              OR :new.fstudiisolicit is null then&amp;lt;br/&amp;gt;          RAISE_APPLICATION_ERROR(-20144, &amp;apos;Nu poate fi APROBATA o cerere fara a fi completate cele trei campuri alaturate!&amp;apos;);&amp;lt;br/&amp;gt;      END IF;     &amp;lt;br/&amp;gt;          &amp;lt;br/&amp;gt;      -- daca omul vrea sa se retraga, adica a fost admisa o cerere de retragere :1 :2&amp;lt;br/&amp;gt;      IF NVL(:NEW.fstudiisolicit, &amp;apos; &amp;apos;) NOT IN (&amp;apos;Z&amp;apos;, &amp;apos;D&amp;apos;) THEN &amp;lt;br/&amp;gt;        -- omul vrea sa se retraga&amp;lt;br/&amp;gt;        /* acest scenariu este imposibil !!!!&amp;lt;br/&amp;gt;        UPDATE fisainscriere&amp;lt;br/&amp;gt;        SET profiladm = profiladm, fstudiiadm = &amp;apos; &amp;apos;, taxaadm = &amp;apos; &amp;apos;, locadm = &amp;apos; &amp;apos;, &amp;lt;br/&amp;gt;                retras = 1, verdict = &amp;apos;RESPINS&amp;apos;, observatii = observatii || &amp;apos; (retras-cerere)&amp;apos;&amp;lt;br/&amp;gt;        WHERE idfisa = :NEW.idfisa ;*/&amp;lt;br/&amp;gt;          NULL ;&amp;lt;br/&amp;gt;      ELSE&amp;lt;br/&amp;gt;          -- omul vrea (alt) ceva&amp;lt;br/&amp;gt;          UPDATE fisainscriere&amp;lt;br/&amp;gt;          SET profiladm = SUBSTR(tipfisa, 1, 1), fstudiiadm = :NEW.fstudiisolicit, &amp;lt;br/&amp;gt;                taxaadm = :NEW.taxasolicit, locadm = :NEW.locsolicit, &amp;lt;br/&amp;gt;                fortat =DECODE (NVL(:NEW.verdict,&amp;apos; &amp;apos;),&amp;apos;A&amp;apos;,1,&amp;apos;P2&amp;apos;,2,&amp;apos;P3&amp;apos;,3,&amp;apos;P4&amp;apos;,4), retras = 0, verdict = &amp;apos;ADMIS&amp;apos;, &amp;lt;br/&amp;gt;                observatii = observatii || DECODE (NVL(:NEW.verdict,&amp;apos; &amp;apos;),&amp;apos;A&amp;apos;,&amp;apos;(admis-cerere)&amp;apos;,&amp;apos;P2&amp;apos;,&amp;apos;(redistribuire faza 2)&amp;apos;,&amp;apos;P3&amp;apos;,&amp;apos;(redistribuire faza 3)&amp;apos;,&amp;apos;P4&amp;apos;,&amp;apos;(redistribuire faza 4)&amp;apos;) &amp;lt;br/&amp;gt;          WHERE idfisa = :NEW.idfisa ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;          -- daca e admis si la celalalt profil, la buget :3&amp;lt;br/&amp;gt;          IF :NEW.taxasolicit &amp;lt;&amp;gt; &amp;apos;T&amp;apos; THEN -- i s-a aprobat la buget      &amp;lt;br/&amp;gt;            UPDATE fisainscriere&amp;lt;br/&amp;gt;            SET taxaadm = &amp;apos;T&amp;apos;, observatii = observatii || &amp;apos; - la celalalt profil e admis la buget&amp;apos;&amp;lt;br/&amp;gt;            WHERE idfisa &amp;lt;&amp;gt; :NEW.idfisa AND cnp = (SELECT cnp FROM fisainscriere WHERE idfisa=:NEW.idfisa)&amp;lt;br/&amp;gt;                  AND profiladm IS NOT NULL AND taxaadm=&amp;apos;F&amp;apos; ;         &amp;lt;br/&amp;gt;          END IF ; &amp;lt;br/&amp;gt;      END IF ;        &amp;lt;br/&amp;gt;    END IF ;&amp;lt;br/&amp;gt;    &amp;lt;br/&amp;gt;END ;</body>
   <triggerTime>AFTER</triggerTime>
   <owner>A19B0135-B306-9C2F-77BB-38712D8BCDB5</owner>
   <table>D6CE6ED0-E2E1-FF27-C991-DC46E8C7ACF8</table>
</TriggerOraclev10g>