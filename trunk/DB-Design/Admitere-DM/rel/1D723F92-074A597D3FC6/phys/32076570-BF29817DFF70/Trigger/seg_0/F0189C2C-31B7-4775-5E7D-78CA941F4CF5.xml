<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="TRG_CERERI_UPD_AFTER_ROW" id="F0189C2C-31B7-4775-5E7D-78CA941F4CF5" directorySegmentName="seg_0">
   <createdBy>catalin.strimbei</createdBy>
   <createdTime>2011-04-20 12:49:06 UTC</createdTime>
   <changedBy>catalin.strimbei</changedBy>
   <changedTime>2011-04-20 12:49:06 UTC</changedTime>
   <ownerDesignName>Admitere-DM</ownerDesignName>
   <actions>UPDATE</actions>
   <body>DECLARE&amp;lt;br/&amp;gt;    v_stare VARCHAR2(300) := &amp;apos;&amp;apos; ;&amp;lt;br/&amp;gt;BEGIN  &amp;lt;br/&amp;gt;    IF :NEW.numar &amp;lt;&amp;gt; :OLD.numar THEN &amp;lt;br/&amp;gt;       RAISE_APPLICATION_ERROR(-20140, &amp;apos;Nu poate fi modificat numarul cererii !&amp;apos;);&amp;lt;br/&amp;gt;    END IF ;       &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    pac_variabile_globale.p_init_vg_atribute (&amp;apos;CERERI&amp;apos;) ;&amp;lt;br/&amp;gt;    v_stare := &amp;apos;modificare in CERERE idfisa: &amp;apos;|| :NEW.idfisa ; &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    SELECT seq_idmodif.NextVal INTO pac_variabile_globale.v_seq_idmodif FROM dual ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    INSERT INTO admitere.modificari (idmodif, dataoram, operator, statiem, obs, &amp;lt;br/&amp;gt;              idfisa, tip_modif, tabela)&amp;lt;br/&amp;gt;        VALUES (pac_variabile_globale.v_seq_idmodif, SYSDATE, &amp;lt;br/&amp;gt;            admitere.pac_variabile_globale.vg_operator, &amp;lt;br/&amp;gt;            admitere.pac_variabile_globale.vg_statie,&amp;lt;br/&amp;gt;            &amp;apos;upd-CERERI&amp;apos;, :NEW.idfisa, &amp;apos;U&amp;apos;, &amp;apos;CERERI&amp;apos;) ;    &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    INSERT INTO upd_CERERI &amp;lt;br/&amp;gt;          (NUMAR, DATAOPERARII, DATASOLUTIONARII, FSTUDIISOLICIT, TAXASOLICIT, LOCSOLICIT,&amp;lt;br/&amp;gt;            OPERATORSOLUTIONARE, STATIESOLUTIONARE, STATIEOPERARE, VERDICT,&amp;lt;br/&amp;gt;            IDFISA, OBSERVATII, IDMODIF) &amp;lt;br/&amp;gt;        VALUES (&amp;lt;br/&amp;gt;            :NEW.NUMAR, :NEW.DATAOPERARII, :NEW.DATASOLUTIONARII, :NEW.FSTUDIISOLICIT, &amp;lt;br/&amp;gt;            :NEW.TAXASOLICIT, :NEW.LOCSOLICIT,&amp;lt;br/&amp;gt;            :NEW.OPERATORSOLUTIONARE, :NEW.STATIESOLUTIONARE, :NEW.STATIEOPERARE, :NEW.VERDICT,&amp;lt;br/&amp;gt;            :NEW.IDFISA, :NEW.OBSERVATII, &amp;lt;br/&amp;gt;            pac_variabile_globale.v_seq_idmodif);&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    pac_variabile_globale.p_prel_val_cereri    (&amp;lt;br/&amp;gt;        :OLD.numar, :OLD.dataoperarii, :OLD.datasolutionarii, :OLD.fstudiisolicit,&amp;lt;br/&amp;gt;        :OLD.taxasolicit, :OLD.locsolicit, :OLD.operatorsolutionare, :OLD.statiesolutionare,&amp;lt;br/&amp;gt;        :OLD.statieoperare, :OLD.verdict, :OLD.idfisa, :OLD.observatii,&amp;lt;br/&amp;gt;        :NEW.numar, :NEW.dataoperarii, :NEW.datasolutionarii, :NEW.fstudiisolicit,&amp;lt;br/&amp;gt;        :NEW.taxasolicit, :NEW.locsolicit, :NEW.operatorsolutionare, :NEW.statiesolutionare,&amp;lt;br/&amp;gt;        :NEW.statieoperare, :NEW.verdict, :NEW.idfisa, :NEW.observatii&amp;lt;br/&amp;gt;    ) ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    IF NVL(:OLD.verdict,&amp;apos; &amp;apos;) &amp;lt;&amp;gt; &amp;apos;A&amp;apos; and NVL(:NEW.verdict,&amp;apos; &amp;apos;) in (&amp;apos;A&amp;apos;,&amp;apos;P2&amp;apos;, &amp;apos;P3&amp;apos;, &amp;apos;P4&amp;apos;) THEN&amp;lt;br/&amp;gt;        IF:new.taxasolicit IS NULL OR :new.locsolicit IS NULL &amp;lt;br/&amp;gt;              OR :new.fstudiisolicit is null then&amp;lt;br/&amp;gt;                RAISE_APPLICATION_ERROR(-20144, &amp;apos;Nu poate fi APROBATA o cerere fara a fi completate cele trei campuri alaturate !&amp;apos;);&amp;lt;br/&amp;gt;        END IF;      &amp;lt;br/&amp;gt;        &amp;lt;br/&amp;gt;        IF NVL(:NEW.fstudiisolicit, &amp;apos; &amp;apos;) NOT IN (&amp;apos;Z&amp;apos;, &amp;apos;D&amp;apos;) THEN &amp;lt;br/&amp;gt;            /*&amp;lt;br/&amp;gt;            -- omul vrea sa se retraga&amp;lt;br/&amp;gt;            UPDATE fisainscriere&amp;lt;br/&amp;gt;            SET profiladm = NULL, fstudiiadm = NULL, taxaadm = NULL, locadm = NULL, &amp;lt;br/&amp;gt;                fortat =1, verdict = &amp;apos;RESPINS&amp;apos;, observatii = observatii || &amp;apos; (retras-cerere)&amp;apos;&amp;lt;br/&amp;gt;            WHERE idfisa = :NEW.idfisa ;&amp;lt;br/&amp;gt;            */&amp;lt;br/&amp;gt;            NULL ;&amp;lt;br/&amp;gt;        ELSE&amp;lt;br/&amp;gt;            -- omul vrea (alt) ceva&amp;lt;br/&amp;gt;           &amp;lt;br/&amp;gt;            UPDATE fisainscriere&amp;lt;br/&amp;gt;            SET profiladm = SUBSTR(tipfisa, 1, 1), fstudiiadm = :NEW.fstudiisolicit, &amp;lt;br/&amp;gt;                taxaadm = :NEW.taxasolicit, locadm = :NEW.locsolicit, &amp;lt;br/&amp;gt;                fortat =DECODE (NVL(:NEW.verdict,&amp;apos; &amp;apos;),&amp;apos;A&amp;apos;,1,&amp;apos;P2&amp;apos;,2,&amp;apos;P3&amp;apos;,3,&amp;apos;P4&amp;apos;,4)&amp;lt;br/&amp;gt;               , verdict = &amp;apos;ADMIS&amp;apos;, observatii = observatii || DECODE (NVL(:NEW.verdict,&amp;apos; &amp;apos;),&amp;apos;A&amp;apos;,&amp;apos;(admis-cerere)&amp;apos;,&amp;apos;P2&amp;apos;,&amp;apos;(redistribuire faza 2)&amp;apos;,&amp;apos;P3&amp;apos;,&amp;apos;(redistribuire faza 3)&amp;apos;,&amp;apos;P4&amp;apos;,&amp;apos;(redistribuire faza 4)&amp;apos;) &amp;lt;br/&amp;gt;            WHERE idfisa = :NEW.idfisa ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;            -- daca e admis si la celalalt profil, la buget :1&amp;lt;br/&amp;gt;            IF :NEW.taxasolicit = &amp;apos;F&amp;apos; THEN -- i s-a aprobat la buget      &amp;lt;br/&amp;gt;                UPDATE fisainscriere&amp;lt;br/&amp;gt;                    SET taxaadm = &amp;apos;T&amp;apos;, observatii = observatii || &amp;apos; - la celalalt profil e admis la buget&amp;apos;&amp;lt;br/&amp;gt;                    WHERE idfisa &amp;lt;&amp;gt; :NEW.idfisa AND cnp = (SELECT cnp FROM fisainscriere WHERE idfisa=:NEW.idfisa)&amp;lt;br/&amp;gt;                        AND profiladm IS NOT NULL AND taxaadm=&amp;apos;F&amp;apos; ;         &amp;lt;br/&amp;gt;            END IF ; &amp;lt;br/&amp;gt;        END IF ;        &amp;lt;br/&amp;gt;    END IF ;&amp;lt;br/&amp;gt;    &amp;lt;br/&amp;gt;    IF NVL(:NEW.verdict,&amp;apos; &amp;apos;) IN (&amp;apos;N&amp;apos;,&amp;apos;R&amp;apos;,&amp;apos;P2&amp;apos;, &amp;apos;P3&amp;apos;, &amp;apos;P4&amp;apos;) &amp;lt;br/&amp;gt;              AND NVL(:OLD.verdict,&amp;apos; &amp;apos;) =&amp;apos;A&amp;apos; THEN -- naspa !!!&amp;lt;br/&amp;gt;       RAISE_APPLICATION_ERROR(-20144, &amp;apos;Nu poate fi modificat un verdict APROBAT !&amp;apos;);&amp;lt;br/&amp;gt;/* d emodificat !!!!!&amp;lt;br/&amp;gt;        UPDATE fisainscriere &amp;lt;br/&amp;gt;            SET profiladm = pac_functii.f_valoare_dinainte(:NEW.idfisa,&amp;apos;PROFILADM&amp;apos;),&amp;lt;br/&amp;gt;                    fstudiiadm = pac_functii.f_valoare_dinainte(:NEW.idfisa,&amp;apos;FSTUDIIADM&amp;apos;),&amp;lt;br/&amp;gt;                    taxaadm = pac_functii.f_valoare_dinainte(:NEW.idfisa,&amp;apos;TAXAADM&amp;apos;),&amp;lt;br/&amp;gt;                    locadm =  pac_functii.f_valoare_dinainte(:NEW.idfisa,&amp;apos;LOCADM&amp;apos;)&amp;lt;br/&amp;gt;                    , fortat = 0, -- pac_functii.f_valoare_dinainte(:NEW.idfisa,&amp;apos;FORTAT&amp;apos;),&amp;lt;br/&amp;gt;                    verdict = pac_functii.f_valoare_dinainte(:NEW.idfisa,&amp;apos;VERDICT&amp;apos;)                 &amp;lt;br/&amp;gt;            WHERE idfisa=:NEW.idfisa ; &amp;lt;br/&amp;gt;  */ &amp;lt;br/&amp;gt;   END IF ;&amp;lt;br/&amp;gt;       &amp;lt;br/&amp;gt;END ;</body>
   <triggerTime>AFTER</triggerTime>
   <owner>A19B0135-B306-9C2F-77BB-38712D8BCDB5</owner>
   <table>D6CE6ED0-E2E1-FF27-C991-DC46E8C7ACF8</table>
</TriggerOraclev10g>