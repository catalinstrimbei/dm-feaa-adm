<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="TRG_FISA_UPD_BEFORE_ROW" id="187077FD-B54B-6B46-39F1-45C3A0A3198D" directorySegmentName="seg_0">
   <createdBy>catalin.strimbei</createdBy>
   <createdTime>2011-04-20 12:49:06 UTC</createdTime>
   <changedBy>catalin.strimbei</changedBy>
   <changedTime>2011-04-20 12:49:06 UTC</changedTime>
   <ownerDesignName>Admitere-DM</ownerDesignName>
   <actions>UPDATE</actions>
   <body>DECLARE&amp;lt;br/&amp;gt;    v_are_voie BOOLEAN := FALSE ;&amp;lt;br/&amp;gt;    v_instante_fisa t_nt_fisainscriere3 ;&amp;lt;br/&amp;gt;BEGIN  &amp;lt;br/&amp;gt;  IF :NEW.idfisa &amp;lt;&amp;gt; :OLD.idfisa THEN &amp;lt;br/&amp;gt;        RAISE_APPLICATION_ERROR (-20159,&amp;apos;IDul fisei nu poate fi modificat !&amp;apos;) ; &amp;lt;br/&amp;gt;  END IF ;&amp;lt;br/&amp;gt;  IF pac_variabile_globale.vg_idfisa_crt IS NULL OR &amp;lt;br/&amp;gt;        pac_variabile_globale.vg_idfisa_crt &amp;lt;&amp;gt; :NEW.idfisa THEN  &amp;lt;br/&amp;gt;    pac_variabile_globale.vg_idfisa_crt := :NEW.idfisa ;&amp;lt;br/&amp;gt;  END IF ;  &amp;lt;br/&amp;gt;  IF :NEW.scutit = 0 THEN&amp;lt;br/&amp;gt;      :NEW.scutire_motivatie := NULL ;    &amp;lt;br/&amp;gt;  END IF ;&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;  IF :NEW.medgenadm &amp;lt;&amp;gt; :OLD.medgenadm THEN &amp;lt;br/&amp;gt;      IF pac_variabile_globale.vg_vin_din_dategen = FALSE  THEN &amp;lt;br/&amp;gt;          IF SUBSTR(:NEW.tipfisa,1,1) IN (&amp;apos;E&amp;apos;, &amp;apos;A&amp;apos;)  THEN &amp;lt;br/&amp;gt;              :new.medgenadm := TRUNC(pac_functii.f_medgenlic(:NEW.cnp) * 0.75 + &amp;lt;br/&amp;gt;                  pac_functii.f_medgenbac(:NEW.cnp) * 0.25, 2) ;&amp;lt;br/&amp;gt;          END IF ;   &amp;lt;br/&amp;gt;          IF SUBSTR(:NEW.tipfisa,1,1) = &amp;apos;M&amp;apos; THEN &amp;lt;br/&amp;gt;              :new.medgenadm := TRUNC(pac_functii.f_medanistud(:NEW.cnp) * 0.6 + &amp;lt;br/&amp;gt;                  pac_functii.f_medlicenta(:NEW.cnp) * 0.4, 2) ;&amp;lt;br/&amp;gt;          END IF ;   &amp;lt;br/&amp;gt;      END IF ;&amp;lt;br/&amp;gt;  END IF ;      &amp;lt;br/&amp;gt;  &amp;lt;br/&amp;gt;  :new.opcorectie := admitere.pac_variabile_globale.vg_operator; &amp;lt;br/&amp;gt;  :new.stcorectie := admitere.pac_variabile_globale.vg_statie; &amp;lt;br/&amp;gt;  :new.datacorectie := sysdate;&amp;lt;br/&amp;gt;  &amp;lt;br/&amp;gt;            --( NVL(:new.contract,0) &amp;lt;&amp;gt; NVL(:old.contract,0) or &amp;lt;br/&amp;gt;     IF   NVL(:new.sumacontract,0)  &amp;lt;&amp;gt; NVL(:old.sumacontract,0) or&amp;lt;br/&amp;gt;        NVL(:new.chitcontract, &amp;apos; &amp;apos;) &amp;lt;&amp;gt; NVL(:old.chitcontract,&amp;apos; &amp;apos;)  THEN -- macar una din astea is modificate&amp;lt;br/&amp;gt;      -- verificam daca toate sunt modificate&amp;lt;br/&amp;gt;      IF -- NVL(:new.contract,0) &amp;gt;0 OR NVL(:new.sumacontract,0) &amp;gt;0 OR &amp;lt;br/&amp;gt;                :new.chitcontract IS NOT NULL THEN -- si s-a modif in sensul introducerii unui contract&amp;lt;br/&amp;gt;            IF -- NVL(:new.contract,0) &amp;gt;0 AND &amp;lt;br/&amp;gt;                  NVL(:new.sumacontract,0) &amp;gt;0 AND &amp;lt;br/&amp;gt;                :new.chitcontract IS NOT NULL THEN &amp;lt;br/&amp;gt;                -- e bine; s-au completat toate cimpurile legate de contracte&amp;lt;br/&amp;gt;                NULL ;&amp;lt;br/&amp;gt;            ELSE&amp;lt;br/&amp;gt;                -- NU e bine; NU s-au completat toate cimpurile legate de contracte&amp;lt;br/&amp;gt;                RAISE_APPLICATION_ERROR (-20152,&amp;lt;br/&amp;gt;                  &amp;apos;CÃ¢nd introduceti contracte trebuie sa completati TOATE datele urmatoare: &amp;apos;||&amp;lt;br/&amp;gt;                    &amp;apos;numarul contractului, numarul chitantei si suma de pe chitanta! Spor!&amp;apos;) ;         &amp;lt;br/&amp;gt;            END IF ;    &amp;lt;br/&amp;gt;       END IF ; &amp;lt;br/&amp;gt;  END IF ; --&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    IF NVL(:NEW.contract,0) &amp;gt; 0 AND NVL(:OLD.contract,0) = 0 THEN &amp;lt;br/&amp;gt;        IF LENGTH(:NEW.observatii) &amp;gt; 2 THEN &amp;lt;br/&amp;gt;          :NEW.observatii := NVL(:NEW.observatii,&amp;apos;&amp;apos;) || &amp;apos;=contract depus=&amp;apos; ;&amp;lt;br/&amp;gt;        ELSE&amp;lt;br/&amp;gt;          :NEW.observatii := &amp;apos;=contract depus=&amp;apos; ;&amp;lt;br/&amp;gt;        END IF ;  &amp;lt;br/&amp;gt;    ELSE&amp;lt;br/&amp;gt;        IF NVL(:NEW.contract,0) &amp;gt; 0 AND NVL(:OLD.contract,0) = 1 THEN &amp;lt;br/&amp;gt;            IF LENGTH(:NEW.observatii) &amp;gt; 2 THEN &amp;lt;br/&amp;gt;                :NEW.observatii := NVL(:NEW.observatii,&amp;apos;&amp;apos;) || &amp;apos;=contract retras=&amp;apos; ;            &amp;lt;br/&amp;gt;            ELSE&amp;lt;br/&amp;gt;                :NEW.observatii := &amp;apos;=contract retras=&amp;apos; ;            &amp;lt;br/&amp;gt;            END IF ;&amp;lt;br/&amp;gt;        END IF ;&amp;lt;br/&amp;gt;    END IF ;     &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    IF NVL(:NEW.retras,0) = 1 AND NVL(:OLD.retras,0) = 0  THEN -- omu&amp;apos; se retrage&amp;lt;br/&amp;gt;        -- DE DE-COMENTAT !!!!&amp;lt;br/&amp;gt;        --    :NEW.fstudiiadm := &amp;apos; &amp;apos; ;&amp;lt;br/&amp;gt;        --    :NEW.taxaadm := &amp;apos; &amp;apos; ;&amp;lt;br/&amp;gt;        --    :NEW.locadm := &amp;apos; &amp;apos;;&amp;lt;br/&amp;gt;        -- -- -- :NEW.fortat := 1 ;&amp;lt;br/&amp;gt;        IF LENGTH(:NEW.observatii) &amp;lt; 80 THEN &amp;lt;br/&amp;gt;            :NEW.observatii := NVL(:NEW.observatii,&amp;apos; &amp;apos;) || &amp;apos; *retragere* &amp;apos; ;&amp;lt;br/&amp;gt;        ELSE&amp;lt;br/&amp;gt;            :NEW.observatii := &amp;apos; *retragere* &amp;apos; ;&amp;lt;br/&amp;gt;        END IF ;  &amp;lt;br/&amp;gt;        :NEW.verdict := &amp;apos;RESPINS&amp;apos; ;     &amp;lt;br/&amp;gt;    END IF ; &amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;  IF NVL(:OLD.retras,0) = 1 AND NVL(:NEW.retras,0) = 0  THEN -- se incearca anularea unei retrageri&amp;lt;br/&amp;gt;      FOR i IN 1..pac_variabile_globale.vg_roluri.COUNT LOOP&amp;lt;br/&amp;gt;          IF pac_variabile_globale.vg_roluri (i) IN (&amp;apos;DBA&amp;apos;, &amp;apos;PRODECAN&amp;apos;) THEN&amp;lt;br/&amp;gt;            v_are_voie := TRUE ;&amp;lt;br/&amp;gt;          END IF ;            &amp;lt;br/&amp;gt;      END LOOP ;&amp;lt;br/&amp;gt;      IF v_are_voie = FALSE THEN&amp;lt;br/&amp;gt;          RAISE_APPLICATION_ERROR (-20142,&amp;apos;Nu aveti suficiente drepturi sa anulati o retragere !&amp;apos;) ;  &amp;lt;br/&amp;gt;      END IF ;&amp;lt;br/&amp;gt;    &amp;lt;br/&amp;gt;    /* hot news !!!&amp;lt;br/&amp;gt;    v_instante_fisa := pac_istoric2007.f_instante_fisainscriere(:NEW.idfisa, 999999999) ;&amp;lt;br/&amp;gt;    IF v_instante_fisa.COUNT = 0 THEN &amp;lt;br/&amp;gt;        RAISE_APPLICATION_ERROR (-20242,&amp;apos;Bug ordinar  !!!&amp;apos;) ;  &amp;lt;br/&amp;gt;    END IF ;&amp;lt;br/&amp;gt;    FOR i IN REVERSE 1..v_instante_fisa.COUNT LOOP&amp;lt;br/&amp;gt;      IF v_instante_fisa(i).retras = 0 THEN&amp;lt;br/&amp;gt;          -- aceasta este instanta inainte de retragege !&amp;lt;br/&amp;gt;          :NEW.profiladm := v_instante_fisa(i).profiladm ;&amp;lt;br/&amp;gt;          :NEW.fstudiiadm := v_instante_fisa(i).fstudiiadm ;&amp;lt;br/&amp;gt;          :NEW.taxaadm := v_instante_fisa(i).taxaadm ;&amp;lt;br/&amp;gt;          :NEW.locadm := v_instante_fisa(i).locadm ;&amp;lt;br/&amp;gt;          --:NEW.verdict := v_instante_fisa(i).verdict ;&amp;lt;br/&amp;gt;          IF LENGTH(:NEW.observatii) &amp;lt; 80 THEN &amp;lt;br/&amp;gt;            :NEW.observatii := NVL(:NEW.observatii,&amp;apos; &amp;apos;) || &amp;apos; /anulez retragere!&amp;apos; ;&amp;lt;br/&amp;gt;          ELSE&amp;lt;br/&amp;gt;            :NEW.observatii := &amp;apos; /anulez retragere!&amp;apos; ;&amp;lt;br/&amp;gt;          END IF ;  &amp;lt;br/&amp;gt;            --:NEW.fortat := 0 ??? ;&amp;lt;br/&amp;gt;          EXIT ;&amp;lt;br/&amp;gt;       ELSE &amp;lt;br/&amp;gt;          IF i=1 THEN &amp;lt;br/&amp;gt;            RAISE_APPLICATION_ERROR (-20243,&amp;apos;Bug si mai ordinar  !!!&amp;apos;) ;  &amp;lt;br/&amp;gt;          END IF ;&amp;lt;br/&amp;gt;       END IF ;   &amp;lt;br/&amp;gt;    END LOOP ;&amp;lt;br/&amp;gt;    */&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;    IF LENGTH(:NEW.observatii) &amp;lt; 900 THEN &amp;lt;br/&amp;gt;         :NEW.observatii := NVL(:NEW.observatii,&amp;apos; &amp;apos;) || &amp;apos; /anulez retragere!&amp;apos; ;&amp;lt;br/&amp;gt;     ELSE&amp;lt;br/&amp;gt;         :NEW.observatii := &amp;apos; /anulez retragere!&amp;apos; ;&amp;lt;br/&amp;gt;    END IF ;  &amp;lt;br/&amp;gt;    -- AICI TREBUIE REVAZUT - daca inainte de retragere era respins ??????&amp;lt;br/&amp;gt;    If :new.fstudiiadm IS NOT NULL And :NEW.taxaadm is not null Then&amp;lt;br/&amp;gt;      :NEW.verdict := &amp;apos;ADMIS&amp;apos; ;&amp;lt;br/&amp;gt;    End If;&amp;lt;br/&amp;gt;    ------ :NEW.fortat := 0 ;&amp;lt;br/&amp;gt;  END IF ; &amp;lt;br/&amp;gt;END ;&amp;lt;br/&amp;gt;</body>
   <triggerTime>BEFORE</triggerTime>
   <owner>A19B0135-B306-9C2F-77BB-38712D8BCDB5</owner>
   <table>0A66D509-BA34-D29E-4656-9909455710E1</table>
</TriggerOraclev10g>